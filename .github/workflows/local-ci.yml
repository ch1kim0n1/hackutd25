name: Local CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.10"

jobs:
  # Backend Testing & Quality Checks
  backend-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.in') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install -e ".[dev]"

    - name: Run linting and formatting
      run: |
        cd backend
        black --check app/
        isort --check-only app/
        ruff check app/

    - name: Run type checking
      run: |
        cd backend
        mypy app/

    - name: Run tests
      run: |
        cd backend
        python -m pytest --cov=app --cov-report=xml --cov-report=term-missing
      env:
        DATABASE_URL: "sqlite:///./test.db"
        REDIS_ENABLED: "false"

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: Backend Coverage

  # Frontend Testing
  frontend-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: client/front/package-lock.json

    - name: Install dependencies
      run: |
        cd client/front
        npm ci

    - name: Run linting
      run: |
        cd client/front
        npm run lint

    - name: Run type checking
      run: |
        cd client/front
        npm run type-check

    - name: Build for production
      run: |
        cd client/front
        npm run build

  # Integration Test
  integration-test:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: client/front/package-lock.json

    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt

    - name: Install frontend dependencies
      run: |
        cd client/front
        npm ci

    - name: Build frontend
      run: |
        cd client/front
        npm run build

    - name: Run integration smoke test
      run: |
        # Start backend in background
        cd backend
        python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        BACKEND_PID=$!

        # Wait for backend to start
        timeout 30 bash -c 'until curl -f http://localhost:8000/health; do sleep 1; done'

        # Test backend health
        curl -f http://localhost:8000/health

        # Test API docs
        curl -f http://localhost:8000/docs

        # Kill backend
        kill $BACKEND_PID

  # Demo Script Test
  demo-test:
    runs-on: windows-latest
    needs: [backend-test, frontend-test]

    steps:
    - uses: actions/checkout@v4

    - name: Test demo script (dry run)
      run: |
        # Basic syntax check
        $ast = [System.Management.Automation.Language.Parser]::ParseFile("scripts/demo-setup.ps1", [ref]$null, [ref]$null)
        if ($ast) {
          Write-Host "✅ Demo script syntax is valid"
        } else {
          Write-Error "❌ Demo script has syntax errors"
          exit 1
        }

    - name: Test batch file exists
      run: |
        if (Test-Path "demo.bat") {
          Write-Host "✅ Demo batch file exists"
        } else {
          Write-Error "❌ Demo batch file missing"
          exit 1
        }

  # Security Scan
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Release
  release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Create GitHub release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ## APEX Financial Operating System Release

          ### Changes
          See commit history for details.

          ### Quick Start
          ```bash
          # Run demo
          .\scripts\demo-setup.ps1
          ```

          ### URLs
          - Frontend: http://localhost:5173
          - API: http://localhost:8000
          - Docs: http://localhost:8000/docs
        draft: false
        prerelease: false
